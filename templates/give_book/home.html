{% extends 'base.html' %}
{% block content %}
<h1 class="text-center my-4">Kitoblar Ro'yxati</h1>

<div class="container">
    <form id="search-form" class="mb-4">
        <div class="row g-3">
            <div class="col-md-2">
                <input type="text" name="code" class="form-control" placeholder="Kodi">
            </div>
            <div class="col-md-2">
                <input type="text" name="name" class="form-control" placeholder="Nomi">
            </div>
            <div class="col-md-2">
                <input type="text" name="author" class="form-control" placeholder="Muallif">
            </div>
            <div class="col-md-2">
                <input type="text" name="year" class="form-control" placeholder="Yili">
            </div>
            <div class="col-md-2">
                <input type="text" name="language" class="form-control" placeholder="Tili">
            </div>
            <div class="col-md-2">
                <input type="text" name="number" class="form-control" placeholder="Soni">
            </div>
        </div>
    </form>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Kodi</th>
                    <th>Nomi</th>
                    <th>Muallif</th>
                    <th>Yili</th>
                    <th>Tili</th>
                    <th>Soni</th>
                    <th>Harakat</th>
                </tr>
            </thead>
            <tbody>
                {% for book in books %}
                <tr>
                    <td>{{ book.book_code }}</td>
                    <td>{{ book.name }}</td>
                    <td>{{ book.authors }}</td>
                    <td>{{ book.year }}</td>
                    <td>{{ book.book_lang }}</td>
                    <td>{{ book.number }}</td>
                    <td>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#pupilModal{{ book.pk }}"
                            {% if book.number == 0 %}disabled{% endif %}>
                            <i class="fas fa-hand-holding"></i> Topshirish
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">Kitoblar topilmadi</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% for book in books %}
<!-- Modal har bir kitob uchun -->
<div class="modal fade" id="pupilModal{{ book.pk }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">{{ book.name }} - Kitobni topshirish</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="faceForm{{ book.pk }}" method="post" action="{% url 'search_pupil' book.pk %}">
                    {% csrf_token %}
                    <div class="text-center mb-3">
                        <video id="video{{ book.pk }}" width="320" height="240" autoplay playsinline class="img-thumbnail"></video>
                        <canvas id="canvas{{ book.pk }}" width="320" height="240" style="display:none;"></canvas>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-info" onclick="captureAndRecognize({{ book.pk }})">
                            <i class="fas fa-camera me-2"></i>Yuzni tanish
                        </button>
                    </div>

                    <div id="pupilInfo{{ book.pk }}" class="mt-3 text-center"></div>
                    <input type="hidden" name="pupil_id" id="pupil_id{{ book.pk }}">

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Bekor qilish
                        </button>
                        <button type="submit" id="confirmBtn{{ book.pk }}" class="btn btn-success" disabled>
                            <i class="fas fa-check me-2"></i>Tasdiqlash
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
// Global o'zgaruvchilar
const streams = {};


// Modal ochilganda kamera ishga tushadi
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('shown.bs.modal', async function() {
        const bookId = this.id.replace('pupilModal', '');
        await startCamera(bookId);
    });

    modal.addEventListener('hidden.bs.modal', function() {
        const bookId = this.id.replace('pupilModal', '');
        stopCamera(bookId);
        resetModal(bookId);
    });
});

// Kamerani ishga tushirish
async function startCamera(bookId) {
    try {
        const video = document.getElementById(`video${bookId}`);

        if (!streams[bookId]) {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: 'user'
                },
                audio: false
            });

            video.srcObject = stream;
            video.play();
            streams[bookId] = stream;
        }
    } catch (err) {
        console.error("Kamera ochilmadi: ", err);
        document.getElementById(`pupilInfo${bookId}`).innerHTML = `
            <div class="alert alert-danger">Kamera ochilmadi: ${err.message}</div>
        `;
    }
}

// Kamerani to'xtatish
function stopCamera(bookId) {
    if (streams[bookId]) {
        streams[bookId].getTracks().forEach(track => track.stop());
        delete streams[bookId];
    }
}

// Modalni qayta tiklash
function resetModal(bookId) {
    document.getElementById(`pupilInfo${bookId}`).innerHTML = '';
    document.getElementById(`confirmBtn${bookId}`).disabled = true;
}

// Rasmga olish va tanish
async function captureAndRecognize(bookId) {
    const video = document.getElementById(`video${bookId}`);
    const canvas = document.getElementById(`canvas${bookId}`);
    const pupilInfo = document.getElementById(`pupilInfo${bookId}`);
    const confirmBtn = document.getElementById(`confirmBtn${bookId}`);
    const pupilIdInput = document.getElementById(`pupil_id${bookId}`);

    try {
        // Rasmga olish
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL('image/jpeg');

        // Yuklash animatsiyasi
        pupilInfo.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div><p>Yuz tahlil qilinmoqda...</p></div>';

        // APIga so'rov yuborish
        const response = await fetch('/give_book/api/recognize_face/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ image: imageData })
        });

        const data = await response.json();

        if (data.success) {
            pupilInfo.innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-user-check me-2"></i>Talaba topildi</h5>
                    <p class="mb-0"><strong>Ism:</strong> ${data.pupil.first_name}</p>
                    <p class="mb-0"><strong>Familiya:</strong> ${data.pupil.last_name}</p>
                    <p class="mb-0"><strong>Guruh:</strong> ${data.pupil.group}</p>
                    <p class="mb-0"><strong>Kurs:</strong> ${data.pupil.course}</p>
                </div>
            `;
            pupilIdInput.value = data.pupil.id;
            confirmBtn.disabled = false;
        } else {
            pupilInfo.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>${data.message || 'Yuz tanish muvaffaqiyatsiz'}
                </div>
            `;
            confirmBtn.disabled = true;
        }
    } catch (error) {
        console.error("Xatolik yuz berdi: ", error);
        pupilInfo.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>Xatolik yuz berdi: ${error.message}
            </div>
        `;
        confirmBtn.disabled = true;
    }
}

// Qidiruv filtri
$(document).ready(function() {
    $('input[name="code"], input[name="name"], input[name="author"], input[name="year"], input[name="language"], input[name="number"]').on('keyup', function() {
        const formData = $('#search-form').serialize();

        $.ajax({
            url: "{% url 'give_book' %}",
            type: "GET",
            data: formData,
            success: function(data) {
                $('tbody').html($(data).find('tbody').html());
            },
            error: function(xhr, status, error) {
                console.error("Xatolik yuz berdi: ", error);
            }
        });
    });
});

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('form[id^="faceForm"]').forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const actionUrl = this.action;

            try {
                const response = await fetch(actionUrl, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                });

                const data = await response.json();
                alert(data.message);

                if (data.success) {
                    // Modalni yopish
                    const modalId = this.closest('.modal').id;
                    const modalEl = document.getElementById(modalId);
                    const modalInstance = bootstrap.Modal.getInstance(modalEl);
                    modalInstance.hide();

                    // Istasangiz sahifani yangilash yoki sonni o'zgartirish kiritish mumkin
                    location.reload();
                }

            } catch (error) {
                alert("Xatolik yuz berdi: " + error.message);
            }
        });
    });
});


</script>

<style>
.camera-container {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 15px;
}
.modal-content {
    border-radius: 10px;
    overflow: hidden;
}
.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
.btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
}
</style>

{% endblock %}